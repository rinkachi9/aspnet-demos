name: Secure Supply Chain Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/advanced-build

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write # Required for Cosign

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    # 1. SCA (Software Composition Analysis)
    # Block build if critical vulnerabilities are found
    - name: Restore dependencies
      run: dotnet restore src/AdvancedBuild/AdvancedBuild.csproj

    - name: Check for Vulnerable Packages (SCA)
      run: |
        dotnet list src/AdvancedBuild/AdvancedBuild.csproj package --vulnerable --include-transitive
        # In strict mode, uncomment below:
        # dotnet list src/AdvancedBuild/AdvancedBuild.csproj package --vulnerable --include-transitive --format json > vulnerabilities.json
        # python3 check_critical.py vulnerabilities.json # Custom script to fail on Critical severity

    # 2. SBOM Generation (CycloneDX)
    - name: Install CycloneDX Tool
      run: dotnet tool install --global CycloneDX

    - name: Generate SBOM
      run: dotnet cyclonedx src/AdvancedBuild/AdvancedBuild.csproj -o sbom -j

    - name: Upload SBOM
      uses: actions/upload-artifact@v4
      with:
        name: sbom-cyclonedx
        path: sbom/bom.json

    # 3. Build & Publish Docker Image
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # - name: Login to Container Registry
    #   uses: docker/login-action@v3
    #   with:
    #     registry: ${{ env.REGISTRY }}
    #     username: ${{ github.actor }}
    #     password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and Export Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: src/AdvancedBuild/Dockerfile
        push: false # Set to true in real repo
        tags: advanced-build:latest
        outputs: type=docker,dest=/tmp/advanced-build.tar

    # 4. Image Signing (Cosign) - Demonstration
    # This step simulates signing. In real pipeline, you would push to registry first, then sign the digest.
    - name: Install Cosign
      uses: sigstore/cosign-installer@v3.3.0

    - name: Sign Image (Dry Run)
      run: |
        echo "Cosign installed version:"
        cosign version
        echo "In a real pipeline with OIDC:"
        echo "cosign sign --yes --key env://COSIGN_PRIVATE_KEY ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@sha256:..."
